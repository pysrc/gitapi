<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>Message</title>
	<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdn.bootcss.com/marked/0.4.0/marked.js"></script>
	<link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/agate.min.css" rel="stylesheet">
	<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
	<script src="lib/api.js"></script>
	<script src="conf.js"></script>
	<script src="confplus.js"></script>
	<script src="lib/apiplus.js"></script>
	<style type="text/css">
		 body{

		   background:url(lib/back.jpg)  no-repeat center center;

		   background-size:cover;

		   background-attachment:fixed;

		}
		.top-buffer{
			margin-top:200px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="row top-buffer">
			<div id="msg-main-view" class="col-sm-9 column">
				<div class="panel panel-primary">
				    <div class="panel-heading">
				        <h3 class="panel-title">留言板</h3>
				    </div>
				    <div class="panel-body">
				        <form role="form">
				            <div class="form-group">
				                <textarea name="content" id="msg-comment" class="form-control" rows="3"  style="resize:none"></textarea>
				            </div>
				            <button type="button" class="btn btn-primary" style="float: right;" data-toggle="modal" data-target="#myModal">留言</button>
				        </form>
				    </div>
				</div>
				<div class="panel panel-primary">
					    <div class="panel-heading">
					        <h3 class="panel-title">留言列表</h3>
					    </div>
				    <div class="panel-body">
						<div id="comments"></div>
						<button type="button" id="msgmorebtn" onclick="msgmore()" class="btn btn-default btn-lg btn-block">加载更多...</button>
				    </div>
				</div>
			</div>
		</div>
	</div>
	<!-- 提交模态框（Modal） -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
						&times;
					</button>
					<h4 class="modal-title" id="myModalLabel">
						登陆Github
					</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="name">用户名</label>
						<input type="text" class="form-control" id="gituser" placeholder="username">
					</div>
					<div class="form-group">
						<label for="name">密码</label>
						<input type="password" class="form-control" id="gitpwd" placeholder="password">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" onclick="subelse()">游客提交</button>
					<button type="button" class="btn btn-primary" onclick="subuser()">Github用户提交</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal -->
	</div>
	<script type="text/javascript">
		//本地issues缓存
		var issues=new Array()
		// 面板上添加新内容
		function newComs(comment,dom){
			if(comment==null){
				return
			}
			var avatar_url = comment.user.avatar_url; // avatar_url
			var muser = comment.user.login;
			if(muser==user){
				muser="Anyone"
			}
			var user_link = comment.user.html_url;
			var updated_at = new Date(comment.updated_at).toLocaleString();
			var body = comment.body;
			var commentHtml = '<div class="media"><a class="media-left" href="'+user_link+'"><img width="50" height="50" class="media-object" src="'+avatar_url+'" alt="媒体对象"></a><div class="media-body"><h4 class="media-heading"><a href="'+user_link+'">'+muser+'</a></h4><small>'+updated_at+'</small><h6></h6>'+body+'</div></div><h2></h2>';
			var new_obj = $(commentHtml);
			dom.append(new_obj);
		}
		//1.留言处理，点击进入留言板时查询留言
		var curMsgPage=0 // 目前留言显示的条数
		initMsg()
		function initMsg(){
			if(curMsgPage)
				return
			msgIssue=getIssue(repo,msgtitle)
			if(!msgIssue){ // 还没有初始化留言板
				msgIssue=newIssue(user,pwd,repo,msgtitle)
			}
			// 获取评论数据
			var msgList=getComments(msgIssue.comments_url,1,pageSizeMsg)
			// 加载评论数据
			if(msgList)
				for(var i=0;i<msgList.length;i++){
					newComs(msgList[i],$('#comments'))
				}
			curMsgPage=1
			issues.push(msgIssue)
		}
		// 评论初始化

		var curComPage=0 // 当前页的评论页数

		// 显示主页
		function mainshow(){
			$("#msg").hide()
			$("#article").show()
		}
		// 向后台写入数据(游客提交模式)
		function subelse(){
			if(cheakmsg()){
				newComs(newComment(user,pwd,getIssueFromList(issues,msgtitle).comments_url,$('#msg-comment').val()),$('#comments'))
				$('#msg-comment').val('')
				$('#myModal').modal('hide')
			}				
		}
		// 向后台写入数据(github用户提交模式)
		function subuser(){
			if(cheakmsg()){
				res = newComment($('#gituser').val(),$('#gitpwd').val(),getIssueFromList(issues,msgtitle).comments_url,$('#msg-comment').val())
				if(res==null){
					alert("用户名或密码错误！")
				}else{
					newComs(res,$('#comments'))
					$('#myModal').modal('hide')
					$('#msg-comment').val('')
				}
			}
		}
		function cheakmsg(){
			if($('#msg-comment').val()==""){
				alert("请输入留言内容!")
				return false
			}
			return true
		}
		// 加载更多留言（下一页）
		function msgmore(){
			curMsgPage++
			// 获取评论数据
			var msgList=getComments(getIssueFromList(issues,msgtitle).comments_url,curMsgPage,pageSizeMsg)
			// 加载评论数据
			if(msgList.length){
				for(var i=0;i<msgList.length;i++){
					newComs(msgList[i],$('#comments'))
				}
				if(msgList.length<pageSizeMsg)
					$("#msgmorebtn").remove()
			}
			else
				$("#msgmorebtn").remove()
		}
	</script>
</body>
</html>