<!DOCTYPE html>
<html>
<head>
	<title>Coding I'm serious</title>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<link rel="stylesheet" href="local_static/bootstrap.min.css">
	<script src="local_static/jquery.min.js"></script>
	<script src="local_static/bootstrap.min.js"></script>
	<script src="local_static/marked.js"></script>
	<link href="local_static/agate.min.css" rel="stylesheet">
	<script src="local_static/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	<script type="text/javascript">
		marked.setOptions({
		    renderer: new marked.Renderer(),
		    highlight: function (code) {
			    return hljs.highlightAuto(code).value;
			}
		});
	</script>
	<style type="text/css">
		 body{

		   background:url(header.jpg)  no-repeat center center;

		   background-size:cover;

		   background-attachment:fixed;

		}
		.top-buffer{
			margin-top:200px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="row top-buffer">
			<div class="col-sm-8 column">
				<div class="panel panel-primary">
					<div class="panel-heading">
						<h3 class="panel-title">
							<div id="ititle"></div>
						</h3>
					</div>
					<div class="panel-body">
						<div id="markdown" onclick="resizeImg()"></div>
					</div>
				</div>
				<ul class="pager">
					<li><a id="first_btn" href="#" onclick="firstPage()">首页</a></li>
					<li><a id="prev_btn" href="#" onclick="prevPage()">上一页</a></li>
					<li><a id="next_btn" href="#" onclick="nextPage()">下一页</a></li>
					<li><a id="last_btn" href="#" onclick="lastPage()">末页</a></li>
					<li><label id="pageLabel"></label></li>
				</ul>
			</div>

			<div class="col-sm-4 column">
				<div class="input-group">
					<input id="search" type="text" class="form-control" placeholder="请输入关键词">
			      	<span class="input-group-btn" onclick="go()">
			        	<button class="btn btn-default" type="button">查找</button>
			      	</span>
				</div>
				<h1></h1>
				<div class="list-group">
					<ul id="alist" class="nav nav-tabs nav-stacked">
		                <li class="active">文章列表</li>
		            </ul>
				</div>
			</div>
		</div>
	</div>

	<div class="jumbotron text-center" style="margin-bottom:0">
	  <p>https://github.com/pysrc</p>
	</div>

	<script type="text/javascript">
		function getText(url){
			text = ""
			$.ajax({
				url: url,
				async: false,
				success:function(result){
					text = result
	    		}
			});
			return text;
		}
		// 解析配置文件
		var conf = eval("("+getText("conf.json")+")")
		var curPage = 1; // 当前页数
		// 显示首页文章
		showPage(1)
		// 显示右侧栏目
		showList(conf.files, conf.mostCount)
		$('#search').keydown(function(event){ // 输入框回车搜索
        	if(event.keyCode == 13)
        	 	go()
    	});

		function show(filepath){ // 显示文章
			$("#ititle").html(filepath.replace(/.*\/(.*?).md/g,"$1"))
			ir = filepath.split("/")
		    ir.pop()
		    // 找到图片地址的前缀
		    var imgsrc = ir.join("/")
		    // 将markdown中的图片地址替换为真实的图片网址
			$("#markdown").html(marked(getText(filepath).replace(/\!\[\]\((.*?)\)/g,"![]("+imgsrc+"/$1)")))
			$('pre').each(function(i, block) { // 将代码块背景美化一下
                hljs.highlightBlock(block);
            });
            resizeImg()
		}
		
		function resizeImg(){
			$('img').each(function() { // 改变图片大小适应div
				maxw = $("#markdown").width()
				if($(this).width()>maxw){
					$(this).css("hight", $(this).height()*($(this).width()/maxw))
					$(this).css("width", maxw)
				}
			})
		}

		function showPage(page){ // 根据页数显示文章
			$("#prev_btn").show()
			$("#next_btn").show()
			if(page<=1){
				page = 1
				curPage = 1
				$("#prev_btn").hide()
			}else if(page>=conf.files.length){
				page = conf.files.length
				curPage = page
				$("#next_btn").hide()
			}
			show(conf.files[conf.files.length-page].path)
			$("#pageLabel").html("第"+curPage+"页，共"+conf.files.length+"页")
		}
		function nextPage(){ // 下一页
			curPage++
			showPage(curPage)
		}
		function prevPage(){
			curPage--
			showPage(curPage)
		}
		function firstPage(){
			curPage = 1
			showPage(curPage)
		}
		function lastPage(){
			curPage = conf.files.length
			showPage(curPage)
		}
		function showList(arr, num){ // 显示文章列表
			$('li[name="item"]').remove()
			stop = arr.length-num
			if(stop<0)
				stop = 0
			for (var i = arr.length - 1; i >= stop; i--) {
				$("#alist").append('<li name="item"><a href="#" onclick="show(\''+arr[i].path+'\')">'+arr[i].path.replace(/.*\/(.*?).md/g,"$1")+'</a></li>')
			}
		}
		
		function go() { // 文章查找
			key = $("#search").val().toUpperCase()
			arr = new Array()
			for (var i = 0; i<=conf.files.length - 1; i++) {
				if(conf.files[i].path.toUpperCase().indexOf(key)!=-1 || conf.files[i].tags.join('|').toUpperCase().indexOf(key)!=-1){
					arr.push(conf.files[i])
				}
			}
			showList(arr, arr.length)
		}
	</script>
</body>
</html>
